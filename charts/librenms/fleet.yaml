# Fleet GitOps 配置檔案
# 用於 Rancher Fleet 自動部署 LibreNMS

# 預設命名空間
defaultNamespace: librenms

# Helm 配置
helm:
  # 測試 PR: fix/snmp-scanner-securitycontext
  # 原始官方 repo: https://www.librenms.org/helm-charts
  # 原始 chart: librenms
  # 原始 version: ""

  # 使用 go-getter URL 格式從 Git repo 下載 chart
  # 格式: git::https://github.com/<org>/<repo>//<path>?ref=<branch>
  chart: git::https://github.com/tryweb/librenms-helm-charts//charts/librenms?ref=fix/snmp-scanner-securitycontext

  # 明確指定 Helm release 名稱
  # 這會影響 LibreNMS poller 尋找的 MySQL Secret 名稱（<releaseName>-mysql）
  # 若不指定，Fleet 會自動生成：<GitRepo名稱>-<路徑>（可能很長且難以預測）
  releaseName: librenms

  # 值檔案路徑（相對於此 fleet.yaml）
  valuesFiles:
    - values.yaml

  # 從 Secret 讀取 MySQL 密碼（解決 Bitnami chart 升級時的密碼驗證問題）
  # Secret 中的 values.yaml key 包含 YAML 格式的 mysql.auth.rootPassword 和 mysql.auth.password
  # 參考：https://fleet.rancher.io/ref-fleet-yaml
  valuesFrom:
    - secretKeyRef:
        name: librenms-helm-values
        namespace: librenms
        key: values.yaml

  # 強制升級（解決某些 CRD 問題）
  force: false

  # 等待所有 Pod 就緒
  waitForJobs: true

# 部署目標 - 必須指定才能部署
# 使用空的 clusterSelector 匹配所有叢集
targets:
  - name: default
    clusterSelector: {}

# 目標叢集自訂配置（可選）
# 針對特定標籤的叢集使用不同的 values 檔案
targetCustomizations:
  - name: production
    clusterSelector:
      matchLabels:
        env: production
    helm:
      valuesFiles:
        - values.yaml
        - values-production.yaml
  
  - name: staging
    clusterSelector:
      matchLabels:
        env: staging
    helm:
      valuesFiles:
        - values.yaml
        - values-staging.yaml

# 差異配置
diff:
  comparePatches:
    - apiVersion: v1
      kind: Secret
      operations:
        - op: remove
          path: /data