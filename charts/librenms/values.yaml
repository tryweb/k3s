# LibreNMS Helm Chart Values
# 此檔案由 Git 管理，透過 Rancher Fleet 自動部署
# 官方 Chart: https://github.com/librenms/helm-charts
#
# ⚠️  敏感資訊（密碼、密鑰）請使用 Kubernetes Secret 管理
#     請參閱 README.md 的「敏感資訊管理」章節
#
# ⚠️  注意：從 Git repo 直接安裝 chart 時，必須提供所有 template 需要的值
#     因為不會自動合併 chart 的預設 values.yaml

# 全域設定
global:
  security:
    allowInsecureImages: true

# LibreNMS 核心配置
librenms:
  # 映像檔設定（必填）
  image:
    repository: librenms/librenms
    tag: "25.11.0"

  # 應用程式密鑰
  # 注意：此值會被 existingSecret 覆蓋，但 chart schema 要求必須提供字串值
  appkey: "placeholder-will-be-overridden-by-secret"
  # 實際密鑰從 Secret 載入（需要先建立 Secret: librenms-app-secret）
  existingSecret: librenms-app-secret

  # 時區設定
  timezone: UTC

  # 自訂配置
  configuration: |
    $config['distributed_poller_group']          = '0';
    $config['distributed_poller']                = true;

  # 額外環境變數（從 Secret 載入 Redis 密碼）
  extraEnvs:
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: librenms-redis-secret
          key: redis-password

  # 額外環境變數來源
  extraEnvFrom: []

  # 全域特權模式
  privileged: false

  # Init Container 配置
  initContainer:
    image:
      repository: busybox
      tag: "1.37"
    resources: {}

  # Frontend 配置
  frontend:
    replicas: 1
    readinessProbe:
      httpGet:
        path: /login
        port: 8000
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 10
    resources: {}
    privileged: false
    nodeSelector: {}
    extraVolumes: []
    extraVolumeMounts: []
    extraEnvs: []
    extraEnvFrom: []

  # Poller 配置
  poller:
    replicas: 3
    resources: {}
    privileged: false
    nodeSelector: {}
    extraVolumes: []
    extraVolumeMounts: []
    extraEnvs: []
    extraEnvFrom: []

  # SNMP Scanner 配置
  # 用於自動發現網路設備
  snmp_scanner:
    enabled: true
    cron: "*/15 * * * *"
    # 安全上下文 - 以 librenms 用戶身分執行（UID 1000）
    # 解決 "lnms must not run as root" 錯誤
    # 參考: https://github.com/librenms/helm-charts/pull/162
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
    resources: {}
    nodeSelector: {}
    extraEnvs: []
    extraEnvFrom: []

  # RRDcached 配置
  rrdcached:
    image:
      repository: crazymax/rrdcached
      tag: "1.8.0"
    persistence:
      enabled: true
      journal:
        size: 1Gi
        storageClassName: "nfs-client"
      rrdcached:
        size: 5Gi
        storageClassName: "nfs-client"
    resources: {}
    readinessProbe:
      tcpSocket:
        port: 42217
      initialDelaySeconds: 5
      periodSeconds: 10
    livenessProbe:
      tcpSocket:
        port: 42217
      initialDelaySeconds: 15
      periodSeconds: 20
    envs:
      - name: WRITE_JITTER
        value: "1800"
      - name: WRITE_TIMEOUT
        value: "1800"
    extraEnvs: []
    extraEnvFrom: []
    nodeSelector: {}
    extraVolumes: []
    extraVolumeMounts: []

# Ingress 配置
ingress:
  enabled: true
  className: "nginx"
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
  hosts:
    - host: nms.k3s.ichiayi.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: wildcard-k3s-ichiayi-com-tls
      hosts:
        - nms.k3s.ichiayi.com

# MySQL 配置 (Bitnami subchart)
mysql:
  enabled: true
  image:
    repository: bitnamilegacy/mysql
  auth:
    database: librenms
    username: librenms
    existingSecret: librenms-mysql-secret
  initdbScriptsConfigMap: ""
  primary:
    persistence:
      enabled: true
      storageClass: "nfs-client"
      size: 10Gi

# Redis 配置 (Bitnami subchart)
redis:
  enabled: true
  image:
    repository: bitnamilegacy/redis
  auth:
    enabled: true
    existingSecret: librenms-redis-secret
    existingSecretPasswordKey: redis-password
  sentinel:
    enabled: false
  master:
    disableCommands: []
    persistence:
      storageClass: "nfs-client"
  architecture: standalone
