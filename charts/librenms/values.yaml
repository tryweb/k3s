# LibreNMS Helm Chart Values
# 此檔案由 Git 管理，透過 Rancher Fleet 自動部署
# 官方 Chart: https://github.com/librenms/helm-charts
#
# ⚠️  敏感資訊（密碼、密鑰）請使用 Kubernetes Secret 管理
#     請參閱 README.md 的「敏感資訊管理」章節

# LibreNMS 核心配置
librenms:
  # 映像檔設定（schema 要求必填）
  image:
    repository: librenms/librenms
    tag: "25.11.0"

  # 應用程式密鑰
  # 注意：此值會被 existingSecret 覆蓋，但 chart schema 要求必須提供字串值
  appkey: "placeholder-will-be-overridden-by-secret"
  # 實際密鑰從 Secret 載入（需要先建立 Secret: librenms-app-secret）
  # Secret 中必須包含 key 名為 "appkey" 的資料
  existingSecret: librenms-app-secret

  # 額外環境變數（從 Secret 載入 Redis 密碼）
  extraEnvs:
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: librenms-redis-secret
          key: redis-password

  # 額外環境變數來源（從 ConfigMap 或 Secret 載入）
  extraEnvFrom: []

  # Frontend 配置
  frontend:
    replicas: 1
    # 資源配置 - 先不設限制，讓 Pod 能啟動
    # 待運行穩定後，根據 kubectl top pods 實際使用量調整
    resources: {}
      # requests:
      #   memory: "256Mi"
      #   cpu: "100m"
      # limits:
      #   memory: "1Gi"
      #   cpu: "500m"

  # SNMP Scanner 配置
  # 用於自動發現網路設備（需要在 LibreNMS Web UI 中啟用 SNMP network discovery）
  snmp_scanner:
    enabled: true
    # Cron 排程（每 15 分鐘執行）
    cron: "*/15 * * * *"
    resources: {}
    nodeSelector: {}
    extraEnvs: []
    extraEnvFrom: []
    # 安全上下文 - 以 librenms 用戶身分執行（UID 1000）
    # 解決 "lnms must not run as root" 錯誤
    # 測試 PR: https://github.com/librenms/helm-charts/pull/XXX
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000

  # RRDcached 配置（必須在 librenms 區塊內）
  # 用於 RRD 資料快取，提升效能
  rrdcached:
    image:
      repository: crazymax/rrdcached
      tag: "1.8.0"
    persistence:
      enabled: true
      journal:
        size: 1Gi
        storageClassName: "nfs-client"
      rrdcached:
        size: 5Gi
        storageClassName: "nfs-client"
    resources: {}

# 資料庫配置 (內建 MySQL - Bitnami chart)
# ⚠️ 重要：Bitnami chart 升級時的密碼驗證問題
# 參考：https://github.com/bitnami/charts/issues/17477
mysql:
  enabled: true
  auth:
    database: librenms
    username: librenms
    # 使用預建立的 Secret（必須在部署前建立）
    # Secret 必須包含 key: mysql-root-password, mysql-password
    existingSecret: librenms-mysql-secret
  # 跳過初始化腳本（避免升級時重新初始化）
  initdbScriptsConfigMap: ""
  primary:
    persistence:
      enabled: true
      storageClass: "nfs-client"  # 使用 NFS StorageClass
      size: 10Gi

# Redis 配置
# 啟用認證，密碼從 existingSecret 載入
redis:
  enabled: true
  auth:
    enabled: true
    existingSecret: librenms-redis-secret
    existingSecretPasswordKey: redis-password
  master:
    persistence:
      storageClass: "nfs-client"  # 使用 NFS StorageClass

# Ingress 配置
ingress:
  enabled: true
  className: "nginx"
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
  hosts:
    - host: nms.k3s.ichiayi.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: wildcard-k3s-ichiayi-com-tls
      hosts:
        - nms.k3s.ichiayi.com

# 服務配置
service:
  type: ClusterIP
  port: 80

# SNMP 配置
snmp:
  community: "public"

# 環境變數
env: {}

# 額外的環境變數從 Secret 載入
envFrom: []

# 副本數
replicaCount: 1

# 節點選擇器
nodeSelector: {}

# 容忍度
tolerations: []

# 親和性
affinity: {}