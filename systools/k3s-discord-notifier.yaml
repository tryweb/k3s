---
# 1. å»ºç«‹ ConfigMap å­˜æ”¾ Discord Webhook URL
apiVersion: v1
kind: ConfigMap
metadata:
  name: discord-webhook-config
  namespace: system-upgrade
data:
  webhook-url: "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"
  # æ›¿æ›æˆä½ çš„ Discord Webhook URL

---
# 2. å»ºç«‹é€šçŸ¥è…³æœ¬çš„ ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: discord-notifier-script
  namespace: system-upgrade
data:
  notify.sh: |
    #!/bin/sh
    
    WEBHOOK_URL="$1"
    TITLE="$2"
    MESSAGE="$3"
    COLOR="$4"  # success: 3066993 (green), failure: 15158332 (red), info: 3447003 (blue)
    
    # å–å¾—å¢é›†è³‡è¨Š
    CLUSTER_NAME="${CLUSTER_NAME:-K3s Cluster}"
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    # å»ºç«‹ Discord Embed JSON
    PAYLOAD=$(cat <<EOF
    {
      "embeds": [{
        "title": "${TITLE}",
        "description": "${MESSAGE}",
        "color": ${COLOR},
        "timestamp": "${TIMESTAMP}",
        "footer": {
          "text": "${CLUSTER_NAME}"
        },
        "fields": [
          {
            "name": "ç¯€é»",
            "value": "${NODE_NAME:-Unknown}",
            "inline": true
          },
          {
            "name": "è¨ˆç•«",
            "value": "${PLAN_NAME:-Unknown}",
            "inline": true
          }
        ]
      }]
    }
    EOF
    )
    
    # ç™¼é€åˆ° Discord
    curl -H "Content-Type: application/json" \
         -d "$PAYLOAD" \
         "$WEBHOOK_URL"

---
# 3. å»ºç«‹ç›£æ§ Job çš„ ServiceAccount å’Œæ¬Šé™
apiVersion: v1
kind: ServiceAccount
metadata:
  name: upgrade-notifier
  namespace: system-upgrade

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: upgrade-notifier
  namespace: system-upgrade
rules:
- apiGroups: ["batch"]
  resources: ["jobs"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: upgrade-notifier
  namespace: system-upgrade
subjects:
- kind: ServiceAccount
  name: upgrade-notifier
  namespace: system-upgrade
roleRef:
  kind: Role
  name: upgrade-notifier
  apiGroup: rbac.authorization.k8s.io

---
# 4. éƒ¨ç½²ç›£æ§å™¨ Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: k3s-upgrade-notifier
  namespace: system-upgrade
  labels:
    app: k3s-upgrade-notifier
spec:
  replicas: 1
  selector:
    matchLabels:
      app: k3s-upgrade-notifier
  template:
    metadata:
      labels:
        app: k3s-upgrade-notifier
    spec:
      serviceAccountName: upgrade-notifier
      containers:
      - name: notifier
        image: bitnami/kubectl:latest
        env:
        - name: WEBHOOK_URL
          valueFrom:
            configMapKeyRef:
              name: discord-webhook-config
              key: webhook-url
        - name: CLUSTER_NAME
          value: "æˆ‘çš„ K3s å¢é›†"  # è‡ªè¨‚ä½ çš„å¢é›†åç¨±
        command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          
          # è¼‰å…¥é€šçŸ¥è…³æœ¬
          cat > /tmp/notify.sh << 'SCRIPT_EOF'
          #!/bin/bash
          WEBHOOK_URL="$1"
          TITLE="$2"
          MESSAGE="$3"
          COLOR="$4"
          CLUSTER_NAME="${CLUSTER_NAME:-K3s Cluster}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "${TITLE}",
              "description": "${MESSAGE}",
              "color": ${COLOR},
              "timestamp": "${TIMESTAMP}",
              "footer": {
                "text": "${CLUSTER_NAME}"
              },
              "fields": [
                {
                  "name": "ç¯€é»",
                  "value": "${NODE_NAME:-Unknown}",
                  "inline": true
                },
                {
                  "name": "è¨ˆç•«",
                  "value": "${PLAN_NAME:-Unknown}",
                  "inline": true
                },
                {
                  "name": "ç‰ˆæœ¬",
                  "value": "${VERSION:-Unknown}",
                  "inline": true
                }
              ]
            }]
          }
          EOF
          )
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL"
          SCRIPT_EOF
          
          chmod +x /tmp/notify.sh
          
          echo "é–‹å§‹ç›£æ§ K3s å‡ç´šä»»å‹™..."
          
          # ç”¨æ–¼è¿½è¹¤å·²è™•ç†çš„ Job
          declare -A processed_jobs
          
          while true; do
            # åˆ—å‡ºæ‰€æœ‰å‡ç´šç›¸é—œçš„ Job
            JOBS=$(kubectl get jobs -n system-upgrade \
              -l upgrade.cattle.io/plan \
              -o json 2>/dev/null)
            
            if [ -z "$JOBS" ]; then
              sleep 30
              continue
            fi
            
            # è™•ç†æ¯å€‹ Job
            echo "$JOBS" | jq -r '.items[] | @base64' | while read -r job; do
              _jq() {
                echo "${job}" | base64 -d | jq -r "${1}"
              }
              
              JOB_NAME=$(_jq '.metadata.name')
              PLAN_NAME=$(_jq '.metadata.labels["upgrade.cattle.io/plan"]')
              NODE_NAME=$(_jq '.metadata.labels["upgrade.cattle.io/node"]')
              
              # å¦‚æœå·²è™•ç†éï¼Œè·³é
              if [ "${processed_jobs[$JOB_NAME]}" = "1" ]; then
                continue
              fi
              
              # æª¢æŸ¥ Job ç‹€æ…‹
              SUCCEEDED=$(_jq '.status.succeeded // 0')
              FAILED=$(_jq '.status.failed // 0')
              ACTIVE=$(_jq '.status.active // 0')
              
              # å–å¾—ç‰ˆæœ¬è³‡è¨Š
              VERSION=$(kubectl get plan $PLAN_NAME -n system-upgrade -o jsonpath='{.status.latestVersion}' 2>/dev/null || echo "Unknown")
              
              export NODE_NAME PLAN_NAME VERSION
              
              if [ "$SUCCEEDED" -gt 0 ]; then
                echo "âœ“ Job $JOB_NAME æˆåŠŸ"
                /tmp/notify.sh "$WEBHOOK_URL" \
                  "ğŸ‰ K3s å‡ç´šæˆåŠŸ" \
                  "ç¯€é» **${NODE_NAME}** å·²æˆåŠŸå‡ç´šåˆ°ç‰ˆæœ¬ **${VERSION}**" \
                  "3066993"
                processed_jobs[$JOB_NAME]=1
                
              elif [ "$FAILED" -gt 0 ]; then
                echo "âœ— Job $JOB_NAME å¤±æ•—"
                
                # å–å¾—éŒ¯èª¤æ—¥èªŒ
                POD_NAME=$(kubectl get pods -n system-upgrade \
                  -l job-name=$JOB_NAME \
                  -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
                
                ERROR_LOG="ç„¡æ³•å–å¾—éŒ¯èª¤æ—¥èªŒ"
                if [ -n "$POD_NAME" ]; then
                  ERROR_LOG=$(kubectl logs -n system-upgrade $POD_NAME --tail=10 2>/dev/null | tail -3)
                fi
                
                /tmp/notify.sh "$WEBHOOK_URL" \
                  "âŒ K3s å‡ç´šå¤±æ•—" \
                  "ç¯€é» **${NODE_NAME}** å‡ç´šå¤±æ•—\n\`\`\`\n${ERROR_LOG}\n\`\`\`" \
                  "15158332"
                processed_jobs[$JOB_NAME]=1
                
              elif [ "$ACTIVE" -gt 0 ]; then
                # åªåœ¨é¦–æ¬¡æª¢æ¸¬åˆ°æ™‚é€šçŸ¥
                if [ "${processed_jobs[${JOB_NAME}_started]}" != "1" ]; then
                  echo "â†’ Job $JOB_NAME é–‹å§‹åŸ·è¡Œ"
                  /tmp/notify.sh "$WEBHOOK_URL" \
                    "ğŸ”„ K3s å‡ç´šé–‹å§‹" \
                    "ç¯€é» **${NODE_NAME}** é–‹å§‹å‡ç´šåˆ°ç‰ˆæœ¬ **${VERSION}**" \
                    "3447003"
                  processed_jobs[${JOB_NAME}_started]=1
                fi
              fi
            done
            
            sleep 30
          done
      restartPolicy: Always

---
# 5. (å¯é¸) ä½¿ç”¨ CronJob å®šæœŸæª¢æŸ¥ä¸¦é€šçŸ¥ç•¶å‰ç‹€æ…‹
apiVersion: batch/v1
kind: CronJob
metadata:
  name: k3s-version-reporter
  namespace: system-upgrade
spec:
  schedule: "0 9 * * 1"  # æ¯é€±ä¸€æ—©ä¸Š 9 é»å ±å‘Š
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: upgrade-notifier
          containers:
          - name: reporter
            image: bitnami/kubectl:latest
            env:
            - name: WEBHOOK_URL
              valueFrom:
                configMapKeyRef:
                  name: discord-webhook-config
                  key: webhook-url
            - name: CLUSTER_NAME
              value: "æˆ‘çš„ K3s å¢é›†"
            command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              
              # æ”¶é›†æ‰€æœ‰ç¯€é»ç‰ˆæœ¬è³‡è¨Š
              NODES_INFO=$(kubectl get nodes -o json | jq -r '.items[] | 
                "**" + .metadata.name + "**: `" + .status.nodeInfo.kubeletVersion + "`"' | 
                paste -sd '\n' -)
              
              # æª¢æŸ¥ Plan ç‹€æ…‹
              PLANS_INFO=$(kubectl get plans -n system-upgrade -o json | jq -r '.items[] | 
                "**" + .metadata.name + "**: " + (.status.latestVersion // "Unknown")' | 
                paste -sd '\n' -)
              
              MESSAGE="**ç¯€é»ç‰ˆæœ¬:**\n${NODES_INFO}\n\n**å‡ç´šè¨ˆç•«:**\n${PLANS_INFO}"
              
              PAYLOAD=$(cat <<EOF
              {
                "embeds": [{
                  "title": "ğŸ“Š K3s å¢é›†ç‹€æ…‹å ±å‘Š",
                  "description": "${MESSAGE}",
                  "color": 3447003,
                  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
                  "footer": {
                    "text": "${CLUSTER_NAME}"
                  }
                }]
              }
              EOF
              )
              
              curl -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL"
          restartPolicy: OnFailure